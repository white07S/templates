from llama_index.core import Document, KnowledgeGraphIndex, Settings
from llama_index.llms.openai import OpenAI
from llama_index.embeddings.openai import OpenAIEmbedding

class KnowledgeGraphSystem:
    def __init__(self):
        # Configure VLLM endpoints
        self.llm = OpenAI(
            api_base="http://localhost:8000/v1",
            api_key="fake-key",  # VLLM doesn't need real key
            temperature=0
        )
        
        self.embedding = OpenAIEmbedding(
            api_base="http://localhost:8000/v1", 
            api_key="fake-key"
        )
        
        # Set global settings
        Settings.llm = self.llm
        Settings.embed_model = self.embedding
        Settings.chunk_size = 512
        
        self.index = None
    
    def ingest(self, text: str):
        """Build knowledge graph + embeddings from text"""
        doc = Document(text=text)
        
        self.index = KnowledgeGraphIndex.from_documents(
            [doc],
            max_triplets_per_chunk=3,
            include_embeddings=True,
            show_progress=True
        )
        
        print("✅ Knowledge graph and embeddings built")
    
    def query(self, question: str):
        """Query using both knowledge graph and embeddings"""
        if not self.index:
            return "❌ No data ingested yet. Call ingest() first."
        
        # Use hybrid mode for both graph relationships and embeddings
        query_engine = self.index.as_query_engine(
            include_text=True,
            response_mode="tree_summarize", 
            embedding_mode="hybrid",
            similarity_top_k=5
        )
        
        response = query_engine.query(question)
        return str(response)

# Usage
kg = KnowledgeGraphSystem()

# Ingest your data
text = """
Tesla is an electric vehicle company founded by Elon Musk. 
The company produces electric cars, solar panels, and energy storage systems.
Tesla's main factory is located in Fremont, California.
Elon Musk is also the CEO of SpaceX, which develops rockets and spacecraft.
"""

kg.ingest(text)

# Query the system
print(kg.query("What does Tesla produce?"))
print(kg.query("Who founded Tesla?"))
print(kg.query("Tell me about Elon Musk's companies"))


pip install llama-index llama-index-llms-openai llama-index-embeddings-openai
